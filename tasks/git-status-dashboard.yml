---
# Unified Git Status Dashboard
# Displays comprehensive repository status for all git-based components
# Shows current state, update status, and commit information

- name: Collect all git repository information
  ansible.builtin.set_fact:
    git_repositories: |
      {%- set repos = [] -%}
      {%- if parking_monitor_repo_info is defined -%}
        {%- set _ = repos.append({
          'name': 'Parking Monitor',
          'component': 'parking_monitor',
          'info': parking_monitor_repo_info
        }) -%}
      {%- endif -%}
      {%- if device_api_repo_info is defined -%}
        {%- set _ = repos.append({
          'name': 'Device API',
          'component': 'device_api', 
          'info': device_api_repo_info
        }) -%}
      {%- endif -%}
      {%- if tracker_repo_info is defined -%}
        {%- set _ = repos.append({
          'name': 'Tracker',
          'component': 'tracker',
          'info': tracker_repo_info
        }) -%}
      {%- endif -%}
      {{ repos }}

- name: Display unified git status dashboard
  ansible.builtin.debug:
    msg: |
      ================================================================================
                              GIT REPOSITORIES STATUS DASHBOARD
      ================================================================================
      Force Update Mode: {{ 'ENABLED' if git_force_update | default(false) else 'DISABLED' }}
      Repositories: {{ git_repositories | length }}
      
      {% for repo in git_repositories %}
      {% set info = repo.info %}
      {{ repo.name | upper }} ({{ repo.component }})
      ├─ Status: {% if info.clone_operation %}CLONED{% elif info.update_operation %}UPDATED{% elif info.force_update_requested %}CURRENT{% else %}UNCHANGED{% endif %} | Branch: {{ info.target_branch }}
      ├─ Commit: {{ info.final_commit[:12] if info.final_commit != 'unknown' else 'unknown' }} | {{ info.final_message[:50] }}{{ '...' if info.final_message | length > 50 else '' }}
      ├─ Author: {{ info.final_author }} | {{ info.final_timestamp[:19] }}
      {% if info.update_operation and info.before_commit != 'none' and info.final_commit != 'unknown' %}
      └─ Updated: {{ info.before_commit[:8] }} → {{ info.final_commit[:8] }}
      {% else %}
      └─ Path: {{ info.destination }}
      {% endif %}
      {% if not loop.last %}
      
      {% endif %}
      {% endfor %}
      ________________________________________________________________________________
      SUMMARY: {{ git_repositories | selectattr('info.clone_operation', 'equalto', true) | list | length }} cloned, {{ git_repositories | selectattr('info.update_operation', 'equalto', true) | list | length }} updated, {{ git_repositories | rejectattr('info.clone_operation', 'equalto', true) | rejectattr('info.update_operation', 'equalto', true) | list | length }} unchanged
      
      USAGE:
      • Use --force flag to update all repositories to latest commits
      • Use --extra-vars "component_force_update=true" for specific updates

- name: No git repositories found
  ansible.builtin.debug:
    msg: |
      ================================================================================
                              GIT REPOSITORIES STATUS DASHBOARD
      ================================================================================
      No repositories managed
      
      This indicates that no git-based components were deployed or that
      git repository management tasks were not executed.
      ================================================================================