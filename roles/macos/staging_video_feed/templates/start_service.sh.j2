#!/bin/bash
# Startup script for Staging Video Feed Service
# Generated by Ansible

set -euo pipefail

# Service configuration
SERVICE_NAME="{{ staging_video_feed_service.name }}"
WORKING_DIR="{{ staging_video_feed_service.working_dir }}"
LOG_FILE="{{ staging_video_feed_logging.log_file }}"
SERVICE_SCRIPT="$WORKING_DIR/staging_video_feed_service.py"

# Environment setup
export LOG_LEVEL="{{ staging_video_feed_service.log_level }}"
export PYTHONPATH="$WORKING_DIR:$PYTHONPATH"

# Create directories if needed
mkdir -p "$(dirname "$LOG_FILE")"
mkdir -p "$WORKING_DIR/logs"

# Function to log messages
log_info() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INFO] $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [ERROR] $1" | tee -a "$LOG_FILE" >&2
}

# Start function
start_service() {
    log_info "Starting $SERVICE_NAME..."
    
    # Verify Python script exists
    if [[ ! -f "$SERVICE_SCRIPT" ]]; then
        log_error "Service script not found: $SERVICE_SCRIPT"
        exit 1
    fi
    
    # Change to working directory
    cd "$WORKING_DIR"
    
    # Start the service
    log_info "Executing: python3 $SERVICE_SCRIPT"
    exec python3 "$SERVICE_SCRIPT"
}

# Main execution
case "${1:-start}" in
    start)
        start_service
        ;;
    *)
        echo "Usage: $0 [start]"
        exit 1
        ;;
esac