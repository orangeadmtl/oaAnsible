---
# Configuration management tasks
# Creates and manages configuration files for the parking monitor service

- name: Create configuration from template
  template:
    src: config.yaml.j2
    dest: "{{ parking_monitor_repository.destination }}/config.yaml"
    mode: '0644'
    backup: "{{ parking_monitor_backup.config_backup | default(true) }}"
  notify: 
    - backup configuration
    - reload parking monitor

- name: Create environment configuration
  template:
    src: parking_monitor.env.j2
    dest: "{{ parking_monitor_repository.destination }}/.env"
    mode: '0600'  # Sensitive environment variables
  notify: reload parking monitor

- name: Create logging configuration
  template:
    src: logging.yaml.j2
    dest: "{{ parking_monitor_repository.destination }}/logging.yaml"
    mode: '0644'

- name: Validate configuration syntax
  shell: |
    cd "{{ parking_monitor_repository.destination }}"
    "{{ parking_monitor_python.env_path }}/bin/python" -c "
    import yaml
    import os
    
    # Validate main config
    try:
        with open('config.yaml', 'r') as f:
            config = yaml.safe_load(f)
        print('[OK] config.yaml syntax valid')
    except yaml.YAMLError as e:
        print(f'[FAIL] config.yaml syntax error: {e}')
        exit(1)
    except FileNotFoundError:
        print('[WARNING]  config.yaml not found - will be created by service')
    
    # Validate logging config
    try:
        with open('logging.yaml', 'r') as f:
            logging_config = yaml.safe_load(f)
        print('[OK] logging.yaml syntax valid')
    except yaml.YAMLError as e:
        print(f'[FAIL] logging.yaml syntax error: {e}')
        exit(1)
    except FileNotFoundError:
        print('[WARNING]  logging.yaml not found')
    
    # Check .env file
    if os.path.exists('.env'):
        print('[OK] .env file created')
    else:
        print('[WARNING]  .env file not found')
    "
  register: config_validation
  changed_when: false

- name: Set configuration file permissions
  file:
    path: "{{ item }}"
    mode: '0644'
    owner: "{{ parking_monitor_service.user }}"
    group: "{{ parking_monitor_service.group }}"
  loop:
    - "{{ parking_monitor_repository.destination }}/config.yaml"
    - "{{ parking_monitor_repository.destination }}/logging.yaml"
  ignore_errors: true

- name: Secure environment file permissions
  file:
    path: "{{ parking_monitor_repository.destination }}/.env"
    mode: '0600'
    owner: "{{ parking_monitor_service.user }}"
    group: "{{ parking_monitor_service.group }}"

- name: Configuration summary
  debug:
    msg: |
      [SVC]  Configuration Setup Complete:
      ===============================
      Main Config: {{ parking_monitor_repository.destination }}/config.yaml
      Environment: {{ parking_monitor_repository.destination }}/.env
      Logging: {{ parking_monitor_repository.destination }}/logging.yaml
      Validation: {{ config_validation.stdout }}
      ==============================="