#!/bin/bash

# Python Environment Setup Script for MediaMTX Demo
# Handles uv installation and virtual environment creation
# This keeps the Python setup out of Ansible and on the deployed machine

set -e

echo "🐍 Python Environment Setup (uv-powered)"
echo "========================================"

cd {{ mediamtx_demo.demo.base_dir }}

# Check if uv is installed
if ! command -v uv >/dev/null 2>&1; then
    echo "📦 Installing uv (fast Python package manager)..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    
    # Add uv to PATH for current session
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # Source shell configuration to make uv available
    if [ -f "$HOME/.zshrc" ]; then
        source "$HOME/.zshrc" 2>/dev/null || true
    elif [ -f "$HOME/.bashrc" ]; then
        source "$HOME/.bashrc" 2>/dev/null || true
    fi
    
    echo "✅ uv installed successfully"
else
    echo "✅ uv already available"
fi

# Verify uv is working
if ! command -v uv >/dev/null 2>&1; then
    echo "❌ uv installation failed or not in PATH"
    echo "💡 Try running: export PATH=\"\$HOME/.cargo/bin:\$PATH\""
    echo "💡 Or restart your shell and run this script again"
    exit 1
fi

UV_VERSION=$(uv --version 2>/dev/null || echo "unknown")
echo "🚀 Using uv version: $UV_VERSION"

# Create virtual environment if it doesn't exist
if [ ! -d "{{ mediamtx_demo.python.venv_path }}" ]; then
    echo "🏗️  Creating virtual environment with uv..."
    uv venv {{ mediamtx_demo.python.venv_path }}
    echo "✅ Virtual environment created: {{ mediamtx_demo.python.venv_path }}"
else
    echo "✅ Virtual environment already exists: {{ mediamtx_demo.python.venv_path }}"
fi

# Install dependencies
echo "📦 Installing Python dependencies with uv..."
export VIRTUAL_ENV="{{ mediamtx_demo.python.venv_path }}"

{% for dep in mediamtx_demo.python.dependencies %}
echo "   Installing {{ dep }}..."
uv pip install {{ dep }}
{% endfor %}

echo "✅ All Python dependencies installed successfully"

echo ""
echo "🎯 Python Environment Ready!"
echo ""
echo "📋 Usage Options:"
echo ""
echo "🚀 Option 1: Use uv run (recommended - no activation needed):"
echo "   uv run --project . python scripts/{{ mediamtx_demo.python.script_name }} --headless"
echo ""
echo "🔧 Option 2: Traditional virtual environment:"
echo "   source {{ mediamtx_demo.python.venv_path }}/bin/activate"
echo "   python scripts/{{ mediamtx_demo.python.script_name }} --headless"
echo "   deactivate"
echo ""
echo "📚 uv is much faster than pip and handles dependencies better!"
echo "   Learn more: https://github.com/astral-sh/uv"