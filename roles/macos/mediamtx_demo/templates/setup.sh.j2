#!/bin/bash

# MediaMTX Demo Setup Script
# Generated by Ansible for {{ inventory_hostname }}
# Simplified verification script - no intrusive testing

echo "ğŸ¥ MediaMTX Demo - Environment Check"
echo "===================================="

cd {{ mediamtx_demo.demo.base_dir }}

echo "âœ… MediaMTX Demo deployed via Ansible"
echo "ğŸ“ Base directory: {{ mediamtx_demo.demo.base_dir }}"
echo "ğŸ”§ Binary location: {{ mediamtx_demo.binary.install_dir }}/mediamtx"
echo "âš™ï¸ Configuration: {{ mediamtx_demo.binary.config_dir }}/mediamtx.yml"

echo ""
echo "ğŸš€ Service Status:"
if launchctl list {{ mediamtx_demo.service.name }} >/dev/null 2>&1; then
    echo "âœ… MediaMTX service is running"
    SERVICE_RUNNING=true
else
    echo "âš ï¸ MediaMTX service not running"
    echo "   Start it with: ./scripts/start.sh"
    SERVICE_RUNNING=false
fi

echo ""
echo "ğŸ Python Environment Setup:"
if [ -f "scripts/setup_python.sh" ]; then
    echo "ğŸ”§ Setting up Python environment with uv..."
    if ./scripts/setup_python.sh; then
        echo "âœ… Python environment ready!"
        PYTHON_READY=true
    else
        echo "âŒ Python environment setup failed"
        echo "ğŸ’¡ Try running: ./scripts/setup_python.sh"
        PYTHON_READY=false
    fi
else
    echo "âŒ Python setup script not found"
    PYTHON_READY=false
fi

echo ""
echo "ğŸ” Quick Environment Test:"
echo "   Run: ./scripts/test_camera.sh"
echo "   (This does NOT test camera access - just verifies the environment)"

echo ""
echo "ğŸ“‹ Ready-to-Use Commands:"
echo ""
echo "ğŸ¬ Start Camera Streaming:"
echo "   ffmpeg -f avfoundation -framerate {{ mediamtx_demo.camera.framerate }} -pixel_format {{ mediamtx_demo.camera.pixel_format }} -i \"{{ mediamtx_demo.camera.device_id }}\" -c:v {{ mediamtx_demo.camera.codec }} -preset {{ mediamtx_demo.camera.preset }} -r {{ mediamtx_demo.camera.framerate }} -f rtsp rtsp://localhost:{{ mediamtx_demo.streaming.rtsp_port }}/{{ mediamtx_demo.streaming.stream_path }}"
echo ""
echo "ğŸ‘€ View Stream:"
echo "   vlc rtsp://localhost:{{ mediamtx_demo.streaming.rtsp_port }}/{{ mediamtx_demo.streaming.stream_path }}"
echo "   vlc rtsp://{{ inventory_hostname }}:{{ mediamtx_demo.streaming.rtsp_port }}/{{ mediamtx_demo.streaming.stream_path }}"
echo ""
echo "ğŸ Python Demo (uv-powered):"
echo "   # Using uv run (recommended):"
echo "   uv run --project . python scripts/{{ mediamtx_demo.python.script_name }} --headless"
echo "   # Or with virtual environment:"
echo "   source {{ mediamtx_demo.python.venv_path }}/bin/activate && python scripts/{{ mediamtx_demo.python.script_name }} --headless && deactivate"

echo ""
echo "ğŸ“Š Service Management:"
echo "   Start service: ./scripts/start.sh"
echo "   Stop service: ./scripts/stop.sh"
echo "   Check status: ./scripts/status.sh"

echo ""
echo "ğŸŒ Network Access:"
echo "   RTSP Stream: rtsp://{{ inventory_hostname }}:{{ mediamtx_demo.streaming.rtsp_port }}/{{ mediamtx_demo.streaming.stream_path }}"
echo "   API Status: http://{{ inventory_hostname }}:{{ mediamtx_demo.streaming.api_port }}/v3/paths/list"

echo ""
echo "ğŸ“‹ Status Summary:"
if [ "$SERVICE_RUNNING" = true ] && [ "$PYTHON_READY" = true ]; then
    echo "âœ… All components ready!"
    echo "ğŸ’¡ Grant camera permissions to Terminal/FFmpeg and start streaming"
else
    echo "âš ï¸  Some components need attention:"
    [ "$SERVICE_RUNNING" = false ] && echo "   - Start MediaMTX service: ./scripts/start.sh"
    [ "$PYTHON_READY" = false ] && echo "   - Check Python virtual environment setup"
fi

echo ""
echo "ğŸ“š Full documentation: README.md"