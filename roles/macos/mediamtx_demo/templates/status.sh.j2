#!/bin/bash
echo "ðŸ“Š MediaMTX Demo Status"
echo "====================="

# Check service status
echo "ðŸ”§ Service Status:"
if launchctl list {{ mediamtx_demo.service.name }} >/dev/null 2>&1; then
    echo "âœ… MediaMTX service is running"
    PID=$(launchctl list {{ mediamtx_demo.service.name }} | grep PID | awk '{print $3}')
    if [ "$PID" != "-" ]; then
        echo "   PID: $PID"
    fi
else
    echo "âŒ MediaMTX service is not running"
fi

echo ""

# Check API
echo "ðŸŒ API Status:"
if curl -s http://localhost:{{ mediamtx_demo.streaming.api_port }}/v1/paths/list >/dev/null 2>&1; then
    echo "âœ… API responding on port {{ mediamtx_demo.streaming.api_port }}"
    
    # Show active paths
    echo ""
    echo "ðŸ“¡ Active Paths:"
    curl -s http://localhost:{{ mediamtx_demo.streaming.api_port }}/v1/paths/list | python3 -m json.tool 2>/dev/null || echo "   (Unable to parse API response)"
else
    echo "âŒ API not responding on port {{ mediamtx_demo.streaming.api_port }}"
fi

echo ""

# Check RTSP port
echo "ðŸŽ¥ RTSP Status:"
if lsof -i :{{ mediamtx_demo.streaming.rtsp_port }} >/dev/null 2>&1; then
    echo "âœ… RTSP server listening on port {{ mediamtx_demo.streaming.rtsp_port }}"
else
    echo "âŒ No RTSP server on port {{ mediamtx_demo.streaming.rtsp_port }}"
fi

echo ""

# Show recent logs
echo "ðŸ“‹ Recent Logs:"
if [ -f "{{ mediamtx_demo.storage.logs_dir }}/stderr.log" ]; then
    echo "Last 5 error lines:"
    tail -n 5 "{{ mediamtx_demo.storage.logs_dir }}/stderr.log" 2>/dev/null || echo "   (No error logs)"
else
    echo "   No log files found"
fi

echo ""
echo "ðŸ”— Stream URL: rtsp://{{ inventory_hostname }}:{{ mediamtx_demo.streaming.rtsp_port }}/{{ mediamtx_demo.streaming.stream_path }}"