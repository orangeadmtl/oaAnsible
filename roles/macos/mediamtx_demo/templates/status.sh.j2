#!/bin/bash
echo "[STATS] MediaMTX Demo Status"
echo "====================="

# Check service status
echo "[CONFIG] Service Status:"
if launchctl list {{ mediamtx_demo.service.name }} >/dev/null 2>&1; then
    echo "[OK] MediaMTX service is running"
    PID=$(launchctl list {{ mediamtx_demo.service.name }} | grep PID | awk '{print $3}')
    if [ "$PID" != "-" ]; then
        echo "   PID: $PID"
    fi
else
    echo "[FAIL] MediaMTX service is not running"
fi

echo ""

# Check API
echo "[WEB] API Status:"
if curl -s http://localhost:{{ mediamtx_demo.streaming.api_port }}/v1/paths/list >/dev/null 2>&1; then
    echo "[OK] API responding on port {{ mediamtx_demo.streaming.api_port }}"
    
    # Show active paths
    echo ""
    echo "[DEPLOY] Active Paths:"
    curl -s http://localhost:{{ mediamtx_demo.streaming.api_port }}/v1/paths/list | python3 -m json.tool 2>/dev/null || echo "   (Unable to parse API response)"
else
    echo "[FAIL] API not responding on port {{ mediamtx_demo.streaming.api_port }}"
fi

echo ""

# Check RTSP port
echo "[VIDEO] RTSP Status:"
if lsof -i :{{ mediamtx_demo.streaming.rtsp_port }} >/dev/null 2>&1; then
    echo "[OK] RTSP server listening on port {{ mediamtx_demo.streaming.rtsp_port }}"
else
    echo "[FAIL] No RTSP server on port {{ mediamtx_demo.streaming.rtsp_port }}"
fi

echo ""

# Show recent logs
echo "[LIST] Recent Logs:"
if [ -f "{{ mediamtx_demo.storage.logs_dir }}/stderr.log" ]; then
    echo "Last 5 error lines:"
    tail -n 5 "{{ mediamtx_demo.storage.logs_dir }}/stderr.log" 2>/dev/null || echo "   (No error logs)"
else
    echo "   No log files found"
fi

echo ""
echo "[LINK] Stream URL: rtsp://{{ inventory_hostname }}:{{ mediamtx_demo.streaming.rtsp_port }}/{{ mediamtx_demo.streaming.stream_path }}"