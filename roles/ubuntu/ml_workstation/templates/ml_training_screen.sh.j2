#!/bin/bash
# ML Training Screen Session Starter
# Generated by Ansible oaAnsible/roles/ubuntu/ml_workstation

OASENTINEL_HOME="{{ ubuntu_oasentinel.install_dir | default(ansible_user_dir + '/oaSentinel') }}"
SESSION_NAME="ml-training"

echo "Starting ML Training Environment"
echo "=================================="

# Check if oaSentinel is set up
if [ ! -d "$OASENTINEL_HOME" ]; then
    echo "[FAIL] oaSentinel not found at $OASENTINEL_HOME"
    exit 1
fi

# Navigate to oaSentinel directory
cd "$OASENTINEL_HOME"

# Activate virtual environment
if [ -f ".venv/bin/activate" ]; then
    source .venv/bin/activate
    echo "[OK] Virtual environment activated"
else
    echo "[FAIL] Virtual environment not found"
    exit 1
fi

# Check if screen session already exists
if screen -list | grep -q "$SESSION_NAME"; then
    echo "Screen session '$SESSION_NAME' already exists"
    echo "Use: screen -r $SESSION_NAME"
    exit 0
fi

# Create new screen session with multiple windows
screen -dmS "$SESSION_NAME"

# Window 0: Main training console
screen -S "$SESSION_NAME" -X screen -t "training" 0
screen -S "$SESSION_NAME" -p 0 -X stuff "cd $OASENTINEL_HOME && source .venv/bin/activate && clear && echo 'Training Console Ready' && echo 'Commands: mltrain, mlprocess, mleval, mlexport'\n"

# Window 1: GPU monitoring
screen -S "$SESSION_NAME" -X screen -t "gpu-monitor" 1  
screen -S "$SESSION_NAME" -p 1 -X stuff "gpu-watch\n"

# Window 2: System monitoring
screen -S "$SESSION_NAME" -X screen -t "system" 2
screen -S "$SESSION_NAME" -p 2 -X stuff "htop\n"

# Window 3: Logs
screen -S "$SESSION_NAME" -X screen -t "logs" 3
screen -S "$SESSION_NAME" -p 3 -X stuff "cd $OASENTINEL_HOME && tail -f logs/training/*.log 2>/dev/null || echo 'No training logs yet. Start training to see logs here.'\n"

echo "[OK] Screen session '$SESSION_NAME' created with 4 windows:"
echo "   0: training   - Main training console"  
echo "   1: gpu-monitor - GPU utilization"
echo "   2: system     - System monitoring (htop)"
echo "   3: logs       - Training logs"
echo ""
echo "Attach to session: screen -r $SESSION_NAME"
echo "Switch windows: Ctrl+A then 0,1,2,3"
echo "Detach: Ctrl+A then d"

# Attach to the session on window 0
screen -r "$SESSION_NAME"