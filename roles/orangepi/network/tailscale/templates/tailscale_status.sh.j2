#!/bin/bash
# OrangePi Tailscale Management Utility
# Generated by Ansible

set -e

DEVICE_NAME="{{ tailscale_hostname }}"

print_header() {
    echo "[ORANGE] Tailscale Status for $DEVICE_NAME"
    echo "======================================"
}

show_status() {
    echo "[DEPLOY] Connection Status:"
    tailscale status --self
    echo ""
    
    echo "[WEB] Network Information:"
    echo "Tailscale IP: $(tailscale ip -4)"
    echo "Tailnet: $(tailscale status --json | jq -r '.MagicDNSSuffix' 2>/dev/null || echo 'N/A')"
    echo ""
    
    echo "[TAGS]  Device Tags:"
    tailscale status --json | jq -r '.Peer[].Tags[]? // "No tags"' 2>/dev/null || echo "N/A"
}

ping_test() {
    local target=${1:-{{ tailscale_hostname }}}
    echo "[PING] Testing connectivity to $target..."
    if tailscale ping "$target" >/dev/null 2>&1; then
        echo "[OK] $target is reachable"
    else
        echo "[FAIL] $target is not reachable"
    fi
}

show_help() {
    echo "OrangePi Tailscale Management"
    echo ""
    echo "Usage: oatailscale [command]"
    echo ""
    echo "Commands:"
    echo "  status    Show Tailscale status (default)"
    echo "  ping      Test connectivity to dashboard"
    echo "  ip        Show Tailscale IP address"
    echo "  restart   Restart Tailscale service"
    echo "  help      Show this help"
}

case "${1:-status}" in
    "status"|"")
        print_header
        show_status
        ;;
    "ping")
        ping_test "${2:-dashboard}"
        ;;
    "ip")
        tailscale ip -4
        ;;
    "restart")
        echo "[CYCLE] Restarting Tailscale..."
        sudo systemctl restart tailscaled
        sleep 3
        show_status
        ;;
    "help"|"-h"|"--help")
        show_help
        ;;
    *)
        echo "[FAIL] Unknown command: $1"
        show_help
        exit 1
        ;;
esac