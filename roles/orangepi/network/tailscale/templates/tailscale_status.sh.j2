#!/bin/bash
# OrangePi Tailscale Management Utility
# Generated by Ansible

set -e

DEVICE_NAME="{{ tailscale_hostname }}"

print_header() {
    echo "üçä Tailscale Status for $DEVICE_NAME"
    echo "======================================"
}

show_status() {
    echo "üì° Connection Status:"
    tailscale status --self
    echo ""
    
    echo "üåê Network Information:"
    echo "Tailscale IP: $(tailscale ip -4)"
    echo "Tailnet: $(tailscale status --json | jq -r '.MagicDNSSuffix' 2>/dev/null || echo 'N/A')"
    echo ""
    
    echo "üè∑Ô∏è  Device Tags:"
    tailscale status --json | jq -r '.Peer[].Tags[]? // "No tags"' 2>/dev/null || echo "N/A"
}

ping_test() {
    local target=${1:-{{ tailscale_hostname }}}
    echo "üèì Testing connectivity to $target..."
    if tailscale ping "$target" >/dev/null 2>&1; then
        echo "‚úÖ $target is reachable"
    else
        echo "‚ùå $target is not reachable"
    fi
}

show_help() {
    echo "OrangePi Tailscale Management"
    echo ""
    echo "Usage: oatailscale [command]"
    echo ""
    echo "Commands:"
    echo "  status    Show Tailscale status (default)"
    echo "  ping      Test connectivity to dashboard"
    echo "  ip        Show Tailscale IP address"
    echo "  restart   Restart Tailscale service"
    echo "  help      Show this help"
}

case "${1:-status}" in
    "status"|"")
        print_header
        show_status
        ;;
    "ping")
        ping_test "${2:-dashboard}"
        ;;
    "ip")
        tailscale ip -4
        ;;
    "restart")
        echo "üîÑ Restarting Tailscale..."
        sudo systemctl restart tailscaled
        sleep 3
        show_status
        ;;
    "help"|"-h"|"--help")
        show_help
        ;;
    *)
        echo "‚ùå Unknown command: $1"
        show_help
        exit 1
        ;;
esac