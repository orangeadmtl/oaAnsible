---
# OrangePi Tailscale Setup Tasks
# Comprehensive Tailscale installation and configuration

- name: Display Tailscale setup banner
  ansible.builtin.debug:
    msg: |
      ╔════════════════════════════════════════════════════╗
      ║            OrangePi Tailscale Network Setup        ║
      ╠════════════════════════════════════════════════════╣
      ║ Hostname: {{ tailscale_hostname }}
      ║ Tags: {{ tailscale_tags | join(', ') }}
      ║ SSH Enable: {{ tailscale_enable_ssh }}
      ╚════════════════════════════════════════════════════╝

- name: Check if Tailscale is already installed
  ansible.builtin.command:
    cmd: which tailscale
  register: tailscale_installed
  failed_when: false
  changed_when: false

- name: Install Tailscale signing key
  ansible.builtin.get_url:
    url: "{{ tailscale_signing_key_url }}"
    dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
    mode: '0644'
  become: true
  when: tailscale_installed.rc != 0

- name: Add Tailscale repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] {{ tailscale_repo_url }} jammy main"
    state: present
    filename: tailscale
  become: true
  when: tailscale_installed.rc != 0

- name: Install Tailscale
  ansible.builtin.apt:
    name: tailscale
    state: present
    update_cache: true
  become: true
  when: tailscale_installed.rc != 0

- name: Enable Tailscale service
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started
    daemon_reload: true
  become: true
  when: enable_tailscale_service

- name: Check current Tailscale status
  ansible.builtin.command:
    cmd: tailscale status --json
  register: tailscale_status
  failed_when: false
  changed_when: false
  become: true

- name: Parse Tailscale status
  ansible.builtin.set_fact:
    tailscale_up: "{{ (tailscale_status.stdout | from_json).BackendState == 'Running' if tailscale_status.rc == 0 else false }}"

- name: Build tailscale up command
  ansible.builtin.set_fact:
    tailscale_up_cmd: >-
      tailscale up
      --authkey={{ tailscale_auth_key }}
      --hostname={{ tailscale_hostname }}
      {% if tailscale_tags %}--advertise-tags={{ tailscale_tags | join(',') }}{% endif %}
      {% if tailscale_advertise_routes %}--advertise-routes={{ tailscale_advertise_routes | join(',') }}{% endif %}
      {% if tailscale_accept_routes %}--accept-routes{% endif %}
      {% if tailscale_enable_ssh %}--ssh{% endif %}
      {% if tailscale_shields_up %}--shields-up{% endif %}
      {% if tailscale_exit_node %}--exit-node={{ tailscale_exit_node }}{% endif %}

- name: Connect to Tailscale
  ansible.builtin.command:
    cmd: "{{ tailscale_up_cmd }}"
  become: true
  when: not tailscale_up
  register: tailscale_connect
  timeout: "{{ tailscale_up_timeout }}"

- name: Wait for Tailscale to be fully connected
  ansible.builtin.command:
    cmd: tailscale status
  register: tailscale_final_status
  become: true
  retries: 10
  delay: 3
  until: tailscale_final_status.rc == 0

- name: Get Tailscale IP address
  ansible.builtin.command:
    cmd: tailscale ip -4
  register: tailscale_ip
  become: true

- name: Update hosts file with Tailscale info
  ansible.builtin.blockinfile:
    path: /etc/hosts
    marker: "# {mark} ANSIBLE MANAGED - Tailscale OrangePi"
    block: |
      # Tailscale configuration for {{ tailscale_hostname }}
      {{ tailscale_ip.stdout.strip() }} {{ tailscale_hostname }}.local
    create: true
  become: true
  when: update_hosts_file

- name: Verify Tailscale connectivity
  include_tasks: verify_connection.yml
  when: verify_connection

- name: Create Tailscale status script
  ansible.builtin.template:
    src: tailscale_status.sh.j2
    dest: "{{ orangepi_project_root }}/util-scripts/oatailscale"
    owner: "{{ orangepi_user }}"
    group: "{{ orangepi_user }}"
    mode: '0755'
  become: true

- name: Display Tailscale setup completion
  ansible.builtin.debug:
    msg: |
      ╔════════════════════════════════════════════════════╗
      ║         Tailscale Setup Complete                   ║
      ╠════════════════════════════════════════════════════╣
      ║ [OK] Tailscale connected and running
      ║ [OK] Hostname: {{ tailscale_hostname }}
      ║ [OK] IP Address: {{ tailscale_ip.stdout.strip() }}
      ║ [OK] Tags: {{ tailscale_tags | join(', ') }}
      ║ [OK] SSH enabled: {{ tailscale_enable_ssh }}
      ║ 
      ║ [TARGET] Use 'oatailscale' for status and management
      ╚════════════════════════════════════════════════════╝